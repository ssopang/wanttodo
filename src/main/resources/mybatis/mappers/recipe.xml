<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "../mybatis-3-mapper.dtd">

<mapper namespace="mapper.recipe">
	<resultMap id="recipeResult" type="recipeVO">
		<result property="rownum" column="rownum" />
		<result property="level" column="level" />
		<result property="recipe_no" column="recipe_no" />
		<result property="recipe_title" column="recipe_title" />
		<result property="recipe_content" column="recipe_content" />
		<result property="recipe_writedate" column="recipe_writedate" />
		<result property="mem_id" column="mem_id" />
		<result property="views" column="views" />
		<result property="goods_id" column="goods_id" />
		<!-- ÏÉÅÌíà ÌÖåÏù¥Î∏î Ï†ïÎ≥¥ -->
		<result property="goods_name" column="goods_name" />  <!-- Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÌÉÄÏûÖ Ï∂îÍ∞Ä -->
		<result property="goods_price" column="goods_price" />  <!-- Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÌÉÄÏûÖ Ï∂îÍ∞Ä -->
		<result property="goods_sales_price" column="goods_sales_price" />  <!-- Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÌÉÄÏûÖ Ï∂îÍ∞Ä -->
		<result property="goods_stock" column="goods_stock" />  <!-- Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÌÉÄÏûÖ Ï∂îÍ∞Ä -->
		<result property="goods_create_date" column="goods_create_date" />  <!-- Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÌÉÄÏûÖ Ï∂îÍ∞Ä -->

		<!-- ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ ÌÖåÏù¥Î∏î Ï†ïÎ≥¥ -->
		<result property="fileName" column="fileName" />  <!-- ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎ™Ö Ï∂îÍ∞Ä -->
		<result property="fileType" column="fileType" />  <!-- Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÌÉÄÏûÖ Ï∂îÍ∞Ä -->

	</resultMap>

	<resultMap id="recipeImageResult" type="recipeimageFileVO">
		<result property="image_id" column="image_id" />
		<result property="fileName" column="fileName" />
		<result property="creDate" column="creDate" />
		<result property="recipe_no" column="recipe_no" />
	</resultMap>

	<resultMap id="commentResult" type="commentVO">
		<result property="rownum" column="rownum" />
		<result property="level" column="level" />
		<result property="comment_no" column="comment_no" />
		<result property="parent_comment_no" column="parent_comment_no" />
		<result property="comment_content" column="comment_content" />
		<result property="comment_writedate" column="comment_writedate" />
		<result property="comment_mod_writedate" column="comment_mod_writedate" />
		<result property="recipe_no" column="recipe_no" />
		<result property="mem_id" column="mem_id" />
		<result property="comment_like" column="comment_like" />
		<result property="comment_dislike" column="comment_dislike" />
		<result property="ratio" column="ratio" />


	</resultMap>

	<select id="selectToRecipes" resultType="int">
	<![CDATA[
		SELECT COUNT(RECIPE_NO) FROM C_RECIPE	
	]]>
	</select>

	<select id="seq_recipe_no_currval" resultType="int">
	<![CDATA[
		SELECT SEQ_RECIPE_NO.CURRVAL 
		FROM DUAL	
	]]>
	</select>
	
	<select id="seq_recipe_no_nextval" resultType="int">
	<![CDATA[
		SELECT SEQ_RECIPE_NO.nextval
		FROM DUAL	
	]]>
	</select>
	
	<select id="checkDuplicateRecipe" parameterType="java.util.Map" resultType="int">
   <![CDATA[
    SELECT COUNT(*) FROM C_RECIPE 
    WHERE RECIPE_TITLE = #{recipe_title} 
    AND DBMS_LOB.COMPARE(RECIPE_CONTENT, #{recipe_content}) = 0
    AND MEM_ID = #{mem_id}
    ]]>
</select>


	<select id="recipeLists" parameterType="java.util.Map"
    resultMap="recipeResult">
    <![CDATA[
    SELECT * FROM (
        SELECT 
            ROWNUM AS rn,
            r.recipe_no,
            r.recipe_title,
            r.recipe_content,
            r.recipe_writedate,
            r.mem_id,
            r.views,
            r.goods_id,
            g.goods_name,
            i.fileName,  -- ‚úÖ main_imageÎßå Í∞ÄÏ†∏Ïò§Í∏∞
            i.fileType   -- ‚úÖ main_imageÎßå Í∞ÄÏ†∏Ïò§Í∏∞
        FROM (
            -- ‚úÖ ÏµúÏã† Îì±Î°ùÎêú Î†àÏãúÌîºÎ•º Î®ºÏ†Ä Ï†ïÎ†¨
            SELECT * FROM C_RECIPE 
            ORDER BY recipe_writedate DESC
        ) r
        LEFT JOIN C_GOODS g 
        ON r.goods_id = g.goods_id  -- ÏÉÅÌíà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        
        LEFT JOIN C_IMAGE_GOODS i 
        ON r.goods_id = i.goods_id  
        AND i.fileType = 'main_image'  --  main_image Ï°∞Í±¥ Ï∂îÍ∞Ä
    ) 
    WHERE rn BETWEEN ((#{section} - 1) * 100 + (#{pageNum} - 1) * 10 + 1) 
                  AND ((#{section} - 1) * 100 + #{pageNum} * 10)
    ORDER BY recipe_writedate DESC  --  ÏµúÏ¢ÖÏ†ÅÏúºÎ°ú Ï†ïÎ†¨ Î≥¥Ïû•
    ]]>
</select>


<select id="getRecipesByGoodsId" parameterType="java.util.Map"
    resultMap="recipeResult">
    <![CDATA[
    SELECT * FROM (
        SELECT 
            ROWNUM AS rn,
            r.recipe_no,
            r.recipe_title,
            r.recipe_content,
            r.recipe_writedate,
            r.mem_id,
            r.views,
            r.goods_id,
            g.goods_name,
            i.fileName,  -- ‚úÖ main_imageÎßå Í∞ÄÏ†∏Ïò§Í∏∞
            i.fileType   -- ‚úÖ main_imageÎßå Í∞ÄÏ†∏Ïò§Í∏∞
        FROM (
            -- ‚úÖ ÏµúÏã† Îì±Î°ùÎêú Î†àÏãúÌîºÎ•º Î®ºÏ†Ä Ï†ïÎ†¨ + ÌäπÏ†ï goods_id Ï°∞Í±¥ Ï∂îÍ∞Ä
            SELECT * FROM C_RECIPE 
            WHERE goods_id = #{goodsId} 
            ORDER BY recipe_writedate DESC
        ) r
        LEFT JOIN C_GOODS g 
        ON r.goods_id = g.goods_id  -- ÏÉÅÌíà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        
        LEFT JOIN C_IMAGE_GOODS i 
        ON r.goods_id = i.goods_id  
        AND i.fileType = 'main_image'  -- ‚úÖ main_image Ï°∞Í±¥ Ï∂îÍ∞Ä
    ) 
    WHERE rn BETWEEN ((#{recipe_section} - 1) * 100 + (#{recipe_pageNum} - 1) * 10 + 1) 
                  AND ((#{recipe_section} - 1) * 100 + #{recipe_pageNum} * 10)
    ORDER BY recipe_writedate DESC  -- ‚úÖ ÏµúÏ¢ÖÏ†ÅÏúºÎ°ú Ï†ïÎ†¨ Î≥¥Ïû•
    ]]>
</select>




	<select id="getToRecipes" resultType="int">
		<![CDATA[
			SELECT COUNT(*) 
			FROM C_RECIPE	
			WHERE goods_id = #{goodsId}
		]]>
	</select>

<!--  Í≤ÄÏÉâÎêú Ï†ÑÏ≤¥ Î†àÏãúÌîº Í∞úÏàò Î∞òÌôò -->
<select id="selectSearchToRecipes" parameterType="java.util.Map" resultType="int">
    SELECT COUNT(*)
    FROM C_RECIPE r
    LEFT JOIN C_GOODS g ON r.goods_id = g.goods_id
    WHERE 1=1
    <if test="searchQuery != null and searchQuery != ''">
        <if test="searchType eq 'recipe_title'">
            AND REGEXP_LIKE(r.recipe_title, REGEXP_REPLACE(#{searchQuery}, '[„Ñ±-„Öé„Öè-„Ö£]', ''))
        </if>
        <if test="searchType eq 'recipe_content'">
            AND REGEXP_LIKE(r.recipe_content, REGEXP_REPLACE(#{searchQuery}, '[„Ñ±-„Öé„Öè-„Ö£]', ''))
        </if>
        <if test="searchType eq 'both'">
            AND (
                REGEXP_LIKE(r.recipe_title, REGEXP_REPLACE(#{searchQuery}, '[„Ñ±-„Öé„Öè-„Ö£]', '')) 
                OR REGEXP_LIKE(r.recipe_content, REGEXP_REPLACE(#{searchQuery}, '[„Ñ±-„Öé„Öè-„Ö£]', ''))
            )
        </if>
    </if>
</select>
<!--  Í≤ÄÏÉâÎêú Î†àÏãúÌîº Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ (ÌéòÏù¥Ïßï Ï†ÅÏö©) -->
<select id="searchRecipeLists" parameterType="java.util.Map" resultMap="recipeResult">
    SELECT * FROM (
        SELECT ROWNUM AS rn, B.* FROM (
            SELECT r.*, g.goods_name, img.fileName  -- ‚úÖ ÏÉÅÌíà Ïù¥Î¶ÑÍ≥º Ïù¥ÎØ∏ÏßÄ ÌååÏùº Ï∂îÍ∞Ä
            FROM C_RECIPE r
            LEFT JOIN C_GOODS g ON r.goods_id = g.goods_id  -- ‚úÖ ÏÉÅÌíà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            LEFT JOIN C_IMAGE_GOODS img 
            ON g.goods_id = img.goods_id 
            AND img.FILETYPE = 'main_image'  -- ‚úÖ main_image Îßå Í∞ÄÏ†∏Ïò§Í∏∞
            WHERE 1=1
            <if test="searchQuery != null and searchQuery != ''">
                <if test="searchType eq 'recipe_title'">
                    AND REGEXP_LIKE(r.recipe_title, REGEXP_REPLACE(#{searchQuery}, '[„Ñ±-„Öé„Öè-„Ö£]', ''))
                </if>
                <if test="searchType eq 'recipe_content'">
                    AND REGEXP_LIKE(r.recipe_content, REGEXP_REPLACE(#{searchQuery}, '[„Ñ±-„Öé„Öè-„Ö£]', ''))
                </if>
                <if test="searchType eq 'both'">
                    AND (
                        REGEXP_LIKE(r.recipe_title, REGEXP_REPLACE(#{searchQuery}, '[„Ñ±-„Öé„Öè-„Ö£]', '')) 
                        OR REGEXP_LIKE(r.recipe_content, REGEXP_REPLACE(#{searchQuery}, '[„Ñ±-„Öé„Öè-„Ö£]', ''))
                    )
                </if>
            </if>
            ORDER BY r.recipe_no DESC
        ) B
    ) 
    WHERE rn BETWEEN ((#{section} - 1) * 100 + (#{pageNum} - 1) * 10 + 1)
                  AND ((#{section} - 1) * 100 + #{pageNum} * 10)
</select>





	<select id="viewRecipe" resultMap="recipeResult">
    <![CDATA[
    SELECT 
        C.*, 
        G.goods_name,
        G.goods_price,
        G.goods_sales_price,
        G.goods_stock,
        G.goods_create_date,
        IG.fileName  -- C_IMAGE_GOODS ÌÖåÏù¥Î∏îÏóêÏÑú fileName Ï∂îÍ∞Ä
    FROM C_RECIPE C
    JOIN C_GOODS G ON C.GOODS_ID = G.GOODS_ID
    LEFT JOIN C_IMAGE_GOODS IG ON C.GOODS_ID = IG.GOODS_ID  -- LEFT JOINÏúºÎ°ú Ï∂îÍ∞Ä (Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏùÑ ÏàòÎèÑ ÏûàÏúºÎØÄÎ°ú)
    WHERE C.RECIPE_NO = #{recipe_no}
    AND IG.FILETYPE = 'main_image'
    ]]>
</select>


	<select id="viewRecipeImages" parameterType="int"
		resultType="recipeimageFileVO">
    <![CDATA[
    SELECT IMAGE_ID, FILENAME, CREDATE, RECIPE_NO 
    FROM C_IMAGE_RECIPE
    WHERE RECIPE_NO = #{recipe_no}
    ORDER BY CREDATE ASC
    ]]>
	</select>

	<!-- ‚úÖ 1Ô∏è‚É£ Î†àÏãúÌîº ÏÇ≠Ï†ú (C_RECIPE ÌÖåÏù¥Î∏î) -->
	<delete id="deleteRecipe">
    <![CDATA[
    DELETE FROM C_RECIPE
    WHERE RECIPE_NO = #{recipe_no}
    ]]>
	</delete>

	<!-- ‚úÖ 2Ô∏è‚É£ Ìï¥Îãπ Î†àÏãúÌîºÏùò Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥ ÏÇ≠Ï†ú (C_IMAGE_RECIPE ÌÖåÏù¥Î∏î) -->
	<delete id="deleteRecipeImageNames">
	<![CDATA[
    DELETE FROM C_IMAGE_RECIPE
    WHERE RECIPE_NO = #{recipe_no}
    ]]>
	</delete>
	
	<delete id="deleteRecipeImage">
	<![CDATA[
	    DELETE FROM C_IMAGE_RECIPE
	    WHERE RECIPE_NO =#{recipe_no}
	    AND fileName = #{fileName}
	 ]]>
	</delete>

   <!-- ÎåìÍ∏Ä Î∞è ÎãµÍ∏Ä ÏÇ≠Ï†ú -->
    <delete id="deleteRecipeComment" parameterType="int">
    	 <![CDATA[
        DELETE FROM c_comment WHERE recipe_no = #{recipe_no}
          ]]>
    </delete>



	<insert id="addRecipe" parameterType="java.util.Map">
    <![CDATA[
    INSERT INTO C_RECIPE(RECIPE_NO, RECIPE_TITLE, RECIPE_CONTENT, MEM_ID,GOODS_ID)
    VALUES (#{recipe_no}, #{recipe_title}, #{recipe_content},#{mem_id},#{goods_id})
    ]]>
	</insert>

	<insert id="insertRecipeImage" parameterType="java.util.Map">
    <![CDATA[
    INSERT INTO C_IMAGE_RECIPE(IMAGE_ID, FILENAME, CREDATE, RECIPE_NO)
    VALUES (SEQ_RECIPE_IMAGE_ID.NEXTVAL, #{fileName}, SYSDATE, #{recipe_no})
    ]]>
	</insert>



	<select id="viewRecipeComment" parameterType="java.util.Map"
		resultType="commentVO">
    <![CDATA[
    SELECT * FROM (
        SELECT 
            ROWNUM AS rn, 
            c.*
        FROM (
            SELECT 
                COMMENT_NO,
                PARENT_COMMENT_NO,
                COMMENT_CONTENT,
                COMMENT_WRITEDATE,
                COMMENT_MOD_WRITEDATE,
                RECIPE_NO,
                MEM_ID,
                COMMENT_LIKE,
                COMMENT_DISLIKE
            FROM C_COMMENT
            WHERE RECIPE_NO = #{recipe_no}
            ORDER BY COMMENT_WRITEDATE DESC
        ) c
        WHERE ROWNUM <= (#{section} - 1) * 100 + (#{pageNum} * 10) -- ‚úÖ Í∞Å section, pageNumÏóê ÎßûÎäî ÏµúÎåÄ Ìñâ
    ) 
    WHERE rn > (#{section} - 1) * 100 + ((#{pageNum} - 1) * 10) -- ‚úÖ Í∞Å section, pageNumÏóê ÎßûÎäî ÏãúÏûë Ìñâ
    ]]>
	</select>



	<!-- üìå 2Ô∏è‚É£ Ï¥ù ÎåìÍ∏Ä Ïàò Ï°∞Ìöå -->
	<select id="selectToComments" parameterType="int"
		resultType="int">
<![CDATA[
    SELECT COUNT(*) FROM C_COMMENT WHERE RECIPE_NO = #{recipe_no}
      ]]>
	</select>

	<insert id="insertComment">
<![CDATA[
        INSERT INTO c_comment (comment_no,recipe_no, mem_id, comment_content)
        VALUES (seq_comment_no.nextval,#{recipe_no}, #{mem_id}, #{comment_content})
      ]]>
	</insert>
	
	  <insert id="insertReplyComment">
	<![CDATA[
        INSERT INTO c_comment (comment_no,parent_comment_no, recipe_no, mem_id, comment_content)
        VALUES (seq_comment_no.nextval,#{parent_comment_no}, #{recipe_no}, #{mem_id}, #{comment_content})
      ]]>
    </insert>
	
	<select id="getLatestComment" resultType="CommentVO">
<![CDATA[
      SELECT * FROM (
    SELECT * FROM c_comment
    WHERE recipe_no = #{recipe_no}
    ORDER BY comment_writedate DESC
) WHERE ROWNUM = 1
      ]]>
	</select>

	<select id="getCommentsByRecipe" resultType="CommentVO">
<![CDATA[
        SELECT * FROM c_comment WHERE recipe_no = #{recipe_no} ORDER BY comment_writedate DESC
      ]]>
	</select>
	<select id="getSortedComments"
		resultType="com.myspring.team.recipe.vo.CommentVO">
    <![CDATA[
    SELECT * FROM (
        SELECT 
            ROWNUM AS rn,
            c.* 
        FROM (
            SELECT 
                COMMENT_NO,
                PARENT_COMMENT_NO,
                COMMENT_CONTENT,
                COMMENT_WRITEDATE,
                COMMENT_MOD_WRITEDATE,
                RECIPE_NO,
                MEM_ID,
                COMMENT_LIKE,
                COMMENT_DISLIKE
            FROM C_COMMENT
            WHERE RECIPE_NO = #{recipe_no}
    ]]>
		<if test="orderBy == 'latest'">
        <![CDATA[ ORDER BY COMMENT_WRITEDATE DESC ]]>
		</if>
		<if test="orderBy == 'like'">
        <![CDATA[ ORDER BY COMMENT_LIKE DESC ]]>
		</if>
    <![CDATA[
        ) c
        WHERE ROWNUM <= (#{section} * 10)
    ) 
    WHERE rn > ((#{section} - 1) * 10)
    ]]>
	</select>



	<!-- ‚úÖ Ìï¥Îãπ Î†àÏãúÌîºÏùò Ï¥ù ÎåìÍ∏Ä Ïàò Í∞ÄÏ†∏Ïò§Í∏∞ -->
	<select id="getTotalComments" resultType="int">
    <![CDATA[
    SELECT COUNT(*) FROM C_COMMENT WHERE RECIPE_NO = #{recipe_no}
    ]]>
	</select>

	<!-- ‚úÖ ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÎêú Í≤ÉÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ -->
	<update id="markCommentAsDeleted">
    <![CDATA[
    UPDATE C_COMMENT
    SET comment_content = 'ÏÇ≠Ï†úÎêú ÎåìÍ∏ÄÏûÖÎãàÎã§.',
        comment_mod_writedate = SYSDATE,
        mem_id ='unknown'
    WHERE comment_no = #{comment_no}
    ]]>
	</update>

	<update id="updateLike">
            <![CDATA[
    UPDATE C_COMMENT 
        SET comment_like = comment_like + 1, 
            ratio = (comment_like + 1) / (comment_like + comment_dislike + 1) * 100 
        WHERE comment_no = #{commentNo}
    ]]>
	</update>

	<!-- Ïã´Ïñ¥Ïöî Ï¶ùÍ∞Ä Î∞è ÎπÑÏú® ÏóÖÎç∞Ïù¥Ìä∏ -->
	<update id="updateDislike">
        <![CDATA[
    UPDATE C_COMMENT 
        SET comment_dislike = comment_dislike + 1, 
            ratio = comment_like / (comment_like + comment_dislike + 1) * 100 
        WHERE comment_no = #{commentNo}
    ]]>
	</update>

	<!-- ÌäπÏ†ï ÎåìÍ∏Ä Í∞ÄÏ†∏Ïò§Í∏∞ -->
	<select id="getComment" resultType="CommentVO">
        <![CDATA[
    SELECT * FROM C_COMMENT WHERE comment_no = #{commentNo}
   ]]>
	</select>

	<select id="modComment" parameterType="java.util.Map">
	 <![CDATA[
	 	UPDATE C_COMMENT       
	 	SET comment_content = #{comment_content},
	 		comment_mod_writedate = sysdate
	 	where comment_no = #{comment_no}
	  ]]>
	
	</select>

	<update id="updateRecipe" parameterType="java.util.Map"> 
	 <![CDATA[
	 	UPDATE C_RECIPE
	 	SET RECIPE_TITLE = #{recipe_title},
	 		RECIPE_CONTENT =#{recipe_content}
	 	WHERE RECIPE_NO = #{recipe_no}
	    ]]>
	</update>
	
	<select id="selectAllComments" resultType="CommentVO">
	 <![CDATA[
	 	select * from c_comment
	    ]]>
	</select>
	
	<update id="updateFilteredContent" parameterType="java.util.Map">
		 <![CDATA[
		 	update c_comment
		 	set comment_content = #{comment_content}
		 	where comment_no = #{comment_no}
		  ]]>
	</update>
	
	<update id="updateViews" parameterType="int">
		 <![CDATA[
		 	update C_RECIPE
		 	set views = views + 1
		 	where recipe_no = #{recipe_no}
		  ]]>
	</update>
	
	
	

</mapper>